<div class="py-4">
  <h4 class="text-center mb-3">Optimised Allocation vs. Response Curves</h4>

  <div class="card p-5 shadow">
    <div class="row g-0">
      <!-- Controls -->
      <div class="col-md-4 p-3 border-end">
        <form>
          <!-- Budget -->
          <div class="mb-4">
            <label class="form-label fw-semibold">
              Budget:
              <span id="budget-value" class="fw-normal">10000</span>
            </label>
            <br />
            <input type="range" class="form-range" id="budget-slider" min="0" max="20000" step="500" value="10000" />
          </div>

          <!-- Market condition -->
          <div class="mb-3">
            <label class="form-label fw-semibold d-block mb-2">Market condition</label>
            <div id="market-condition" class="d-flex gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="marketCond" id="cond-bad" value="bad">
                <label class="form-check-label" for="cond-bad">Bad</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="marketCond" id="cond-normal" value="normal" checked>
                <label class="form-check-label" for="cond-normal">Normal</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="marketCond" id="cond-good" value="good">
                <label class="form-check-label" for="cond-good">Good</label>
              </div>
            </div>
            <div class="form-text mt-2">
              Curves scale by channel-specific multipliers per market condition.
            </div>
          </div>
        </form>
      </div>

      <!-- Charts -->
      <div class="col-md-8 p-3">
        <div class="row">
          <div class="col-12 d-flex align-items-center justify-content-center mb-4">
            <canvas id="budget-chart" width="500" height="300" aria-label="Response Curves"></canvas>
          </div>
          <div class="col-12 d-flex align-items-center justify-content-center">
            <canvas id="spend-bars" width="500" height="220" aria-label="Spend by Channel"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // ---- Data (self contained) ----
  const curvesData = [/* your curves data from message, unchanged */ 
    {"category":"Display","spend":0,"uplift":0},{"category":"Generic SEA","spend":0,"uplift":0},{"category":"Social","spend":0,"uplift":0},{"category":"TV","spend":0,"uplift":0},
    {"category":"Display","spend":500,"uplift":500},{"category":"Generic SEA","spend":500,"uplift":1000},{"category":"Social","spend":500,"uplift":540},{"category":"TV","spend":500,"uplift":285.5748},
    {"category":"Display","spend":1000,"uplift":750},{"category":"Generic SEA","spend":1000,"uplift":1500},{"category":"Social","spend":1000,"uplift":900},{"category":"TV","spend":1000,"uplift":545.1882},
    {"category":"Display","spend":1500,"uplift":900},{"category":"Generic SEA","spend":1500,"uplift":1800},{"category":"Social","spend":1500,"uplift":1157.1429},{"category":"TV","spend":1500,"uplift":782.2266},
    {"category":"Display","spend":2000,"uplift":1000},{"category":"Generic SEA","spend":2000,"uplift":2000},{"category":"Social","spend":2000,"uplift":1350},{"category":"TV","spend":2000,"uplift":999.5117},
    {"category":"Display","spend":2500,"uplift":1071.4286},{"category":"Generic SEA","spend":2500,"uplift":2142.8571},{"category":"Social","spend":2500,"uplift":1500},{"category":"TV","spend":2500,"uplift":1199.4141},
    {"category":"Display","spend":3000,"uplift":1125},{"category":"Generic SEA","spend":3000,"uplift":2250},{"category":"Social","spend":3000,"uplift":1620},{"category":"TV","spend":3000,"uplift":1383.9393},
    {"category":"Display","spend":3500,"uplift":1166.6667},{"category":"Generic SEA","spend":3500,"uplift":2333.3333},{"category":"Social","spend":3500,"uplift":1718.1818},{"category":"TV","spend":3500,"uplift":1554.796},
    {"category":"Display","spend":4000,"uplift":1200},{"category":"Generic SEA","spend":4000,"uplift":2400},{"category":"Social","spend":4000,"uplift":1800},{"category":"TV","spend":4000,"uplift":1713.4487},
    {"category":"Display","spend":4500,"uplift":1227.2727},{"category":"Generic SEA","spend":4500,"uplift":2454.5455},{"category":"Social","spend":4500,"uplift":1869.2308},{"category":"TV","spend":4500,"uplift":1861.1598},
    {"category":"Display","spend":5000,"uplift":1250},{"category":"Generic SEA","spend":5000,"uplift":2500},{"category":"Social","spend":5000,"uplift":1928.5714},{"category":"TV","spend":5000,"uplift":1999.0234},
    {"category":"Display","spend":5500,"uplift":1269.2308},{"category":"Generic SEA","spend":5500,"uplift":2538.4615},{"category":"Social","spend":5500,"uplift":1980},{"category":"TV","spend":5500,"uplift":2127.9927},
    {"category":"Display","spend":6000,"uplift":1285.7143},{"category":"Generic SEA","spend":6000,"uplift":2571.4286},{"category":"Social","spend":6000,"uplift":2025},{"category":"TV","spend":6000,"uplift":2248.9014},
    {"category":"Display","spend":6500,"uplift":1300},{"category":"Generic SEA","spend":6500,"uplift":2600},{"category":"Social","spend":6500,"uplift":2064.7059},{"category":"TV","spend":6500,"uplift":2362.4822},
    {"category":"Display","spend":7000,"uplift":1312.5},{"category":"Generic SEA","spend":7000,"uplift":2625},{"category":"Social","spend":7000,"uplift":2100},{"category":"TV","spend":7000,"uplift":2469.3819},
    {"category":"Display","spend":7500,"uplift":1323.5294},{"category":"Generic SEA","spend":7500,"uplift":2647.0588},{"category":"Social","spend":7500,"uplift":2131.5789},{"category":"TV","spend":7500,"uplift":2570.173},
    {"category":"Display","spend":8000,"uplift":1333.3333},{"category":"Generic SEA","spend":8000,"uplift":2666.6667},{"category":"Social","spend":8000,"uplift":2160},{"category":"TV","spend":8000,"uplift":2665.3646},
    {"category":"Display","spend":8500,"uplift":1342.1053},{"category":"Generic SEA","spend":8500,"uplift":2684.2105},{"category":"Social","spend":8500,"uplift":2185.7143},{"category":"TV","spend":8500,"uplift":2755.4107},
    {"category":"Display","spend":9000,"uplift":1350},{"category":"Generic SEA","spend":9000,"uplift":2700},{"category":"Social","spend":9000,"uplift":2209.0909},{"category":"TV","spend":9000,"uplift":2840.7175},
    {"category":"Display","spend":9500,"uplift":1357.1429},{"category":"Generic SEA","spend":9500,"uplift":2714.2857},{"category":"Social","spend":9500,"uplift":2230.4348},{"category":"TV","spend":9500,"uplift":2921.6496},
    {"category":"Display","spend":10000,"uplift":1363.6364},{"category":"Generic SEA","spend":10000,"uplift":2727.2727},{"category":"Social","spend":10000,"uplift":2250},{"category":"TV","spend":10000,"uplift":2998.5352}
  ];

  const optimData = [/* your optim data from message, unchanged (kept short here) */ 
    {"category":"Generic SEA","channel_spend":0,"channel_uplift":0,"budget":0},
    {"category":"Social","channel_spend":0,"channel_uplift":0,"budget":0},
    {"category":"Display","channel_spend":0,"channel_uplift":0,"budget":0},
    {"category":"TV","channel_spend":0,"channel_uplift":0,"budget":0},
    {"category":"Generic SEA","channel_spend":500,"channel_uplift":1000,"budget":500},
    {"category":"Social","channel_spend":0,"channel_uplift":0,"budget":500},
    /* ... include the rest exactly as in your message ... */
    {"category":"TV","channel_spend":10000,"channel_uplift":2998.5352,"budget":20500}
  ];

  const categoryColors = {
    "TV": "rgba(255, 99, 132, 1)",
    "Generic SEA": "rgba(54, 162, 235, 1)",
    "Display": "rgba(255, 206, 86, 1)",
    "Social": "rgba(75, 192, 192, 1)"
  };

  // ---- Per-market multipliers (slightly different per curve) ----
  const marketMultipliers = {
    bad:   { "Display": 0.78, "Generic SEA": 0.82, "Social": 0.80, "TV": 0.76 },
    normal:{ "Display": 1.00, "Generic SEA": 1.00, "Social": 1.00, "TV": 1.00 },
    good:  { "Display": 1.18, "Generic SEA": 1.22, "Social": 1.20, "TV": 1.24 }
  };

  // ---- Utilities ----
  const ensureChartJs = (cb) => {
    if (window.Chart) return cb();
    const s = document.createElement('script');
    s.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";
    s.onload = cb;
    document.head.appendChild(s);
  };

  const epsilon = 1e-6;
  const uniq = (arr) => [...new Set(arr)];
  const categories = uniq(curvesData.map(d => d.category));

  // Precompute base curves by category once
  const baseCurves = Object.fromEntries(
    categories.map(cat => [
      cat,
      curvesData.filter(d => d.category === cat).map(d => ({ x: d.spend, baseY: d.uplift }))
    ])
  );

  const getOptimPoint = (cat, budget) =>
    optimData.find(d => d.category === cat && d.budget === budget);

  const scaledCurve = (cat, condition) => {
    const m = (marketMultipliers[condition] || {})[cat] ?? 1.0;
    return baseCurves[cat].map(p => ({ x: p.x, y: p.baseY * m }));
  };

  const scaledOptimY = (cat, budget, condition) => {
    const m = (marketMultipliers[condition] || {})[cat] ?? 1.0;
    const row = getOptimPoint(cat, budget);
    return row ? row.channel_uplift * m : null;
  };

  const spendByCategoryAtBudget = (budget) =>
    categories.map(cat => getOptimPoint(cat, budget)?.channel_spend ?? 0);

  // ---- Init after DOM + Chart.js ----
  document.addEventListener('DOMContentLoaded', () => {
    ensureChartJs(() => {
      const lineCtx = document.getElementById('budget-chart').getContext('2d');
      const barCtx  = document.getElementById('spend-bars').getContext('2d');

      const budgetSlider = document.getElementById('budget-slider');
      const budgetValue  = document.getElementById('budget-value');
      const marketRadios = document.querySelectorAll('#market-condition input[name="marketCond"]');

      let selectedBudget = parseInt(budgetSlider.value, 10);
      let condition = document.querySelector('#market-condition input[name="marketCond"]:checked').value;

      // ----- Line datasets (scaled) -----
      const lineDatasets = categories.map(cat => {
        const color = categoryColors[cat] || 'rgba(100,100,100,1)';
        const scaled = scaledCurve(cat, condition);
        const opt = getOptimPoint(cat, selectedBudget);
        const optY = scaledOptimY(cat, selectedBudget, condition);

        return {
          label: `${cat} Curve`,
          data: scaled,
          type: 'line',
          borderWidth: 2,
          borderColor: color,
          fill: false,
          tension: 0.4,
          pointRadius: scaled.map(p =>
            (opt && Math.abs(p.x - opt.channel_spend) < epsilon && optY !== null && Math.abs(p.y - optY) < epsilon) ? 5 : 0
          ),
          pointBackgroundColor: scaled.map(p =>
            (opt && Math.abs(p.x - opt.channel_spend) < epsilon && optY !== null && Math.abs(p.y - optY) < epsilon) ? color : 'transparent'
          ),
          pointBorderColor: scaled.map(() => color)
        };
      });

      const lineChart = new Chart(lineCtx, {
        type: 'line',
        data: { datasets: lineDatasets },
        options: {
          responsive: true,
          parsing: false,
          animation: false,
          plugins: { legend: { display: true } },
          scales: {
            x: { type: 'linear', title: { display: true, text: 'Spend' }, beginAtZero: true, grid: { display: false } },
            y: { title: { display: true, text: 'Uplift' }, beginAtZero: true, grid: { display: false } }
          }
        }
      });

      // ----- Bar chart (spend by category at selected budget) -----
      const barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: categories,
          datasets: [{
            label: 'Spend @ Budget',
            data: spendByCategoryAtBudget(selectedBudget),
            backgroundColor: categories.map(cat => (categoryColors[cat] || 'rgba(100,100,100,1)').replace(', 1)', ', 0.35)')),
            borderColor: categories.map(cat => categoryColors[cat] || 'rgba(100,100,100,1)'),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          animation: false,
          plugins: { legend: { display: true } },
          scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true, title: { display: true, text: 'Spend' }, grid: { display: false } }
          }
        }
      });

      function updateCharts() {
        selectedBudget = parseInt(budgetSlider.value, 10);
        budgetValue.textContent = selectedBudget;

        // Update line (re-scale curves + highlight)
        lineChart.data.datasets.forEach(ds => {
          const cat = ds.label.replace(' Curve', '');
          const color = categoryColors[cat] || 'rgba(100,100,100,1)';
          const scaled = scaledCurve(cat, condition);
          const opt = getOptimPoint(cat, selectedBudget);
          const optY = scaledOptimY(cat, selectedBudget, condition);

          ds.data = scaled;
          ds.pointRadius = scaled.map(p =>
            (opt && Math.abs(p.x - opt.channel_spend) < epsilon && optY !== null && Math.abs(p.y - optY) < epsilon) ? 5 : 0
          );
          ds.pointBackgroundColor = scaled.map(p =>
            (opt && Math.abs(p.x - opt.channel_spend) < epsilon && optY !== null && Math.abs(p.y - optY) < epsilon) ? color : 'transparent'
          );
          ds.pointBorderColor = scaled.map(() => color);
        });
        lineChart.update();

        // Update bars
        barChart.data.datasets[0].data = spendByCategoryAtBudget(selectedBudget);
        barChart.update();
      }

      budgetSlider.addEventListener('input', updateCharts);
      marketRadios.forEach(r => r.addEventListener('change', (e) => {
        condition = e.target.value;
        updateCharts();
      }));
    });
  });
})();
</script>
